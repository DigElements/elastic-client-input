<!doctype html>

<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, minimum-scale=1.0, initial-scale=1.0, user-scalable=yes">

        <script src="../../webcomponentsjs/webcomponents-lite.js"></script>
        <script src="../../web-component-tester/browser.js"></script>

        <link rel="import" href="../elastic-client-input.html">
    </head>
    <body>
        <test-fixture id="elastic-client-input-fixture">
            <template>
                <elastic-client-input
                    field="my.field">
                </elastic-client-input>
            </template>
        </test-fixture>

        <script>
            suite('<elastic-client-input>', function() {
                var component;

                setup(function() {
                    component = fixture('elastic-client-input-fixture');
                });

                test('defines the field property', function () {
                    assert.equal(component.field, 'my.field');
                });

                test('sets label value to field value if not defined', function() {
                    assert.equal(component.labelValue, 'my.field');
                });

                test('properly sets the label if defined', function() {
                    component.label = 'mylabel';
                    assert.equal(component.labelValue, 'mylabel');
                    var label = component.$$('paper-input').querySelector(':scope label');
                    assert.equal(label.textContent, 'mylabel');
                });

                test('correctly defaults advanced', function() {
                    assert.equal(component.advanced, false);
                });

                test('does not build query on keydown if key is not enter', function() {
                    expect(component.query).not.to.exist;
                    component.value = 'foo';
                    component._onKeydown({
                      keyCode: 1
                    });
                    expect(component.query).to.not.exist;
                });

                test('does build query on keydown if key is enter', function() {
                    expect(component.query).not.to.exist;
                    component.value = 'foo';
                    component._onKeydown({
                      keyCode: 13
                    });
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('foo').fields('my.field').toJSON());
                });

                test('does not build query on empty input', function() {
                    expect(component.query).not.to.exist;
                    component.value = '';
                    component._build();
                    expect(component.query).not.to.exist;
                });

                test('does not build query on whitespace input', function() {
                    expect(component.query).not.to.exist;
                    component.value = ' ';
                    component._build();
                    expect(component.query).not.to.exist;
                });

                test('does build match all query on null input', function() {
                    expect(component.query).not.to.exist;
                    component.value = null;
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.MatchAllQuery().toJSON());
                });

                test('correctly changes query on changing input string', function() {
                    expect(component.query).not.to.exist;
                    component.value = 'foo';
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('foo').fields('my.field').toJSON());
                    component.value = 'bar';
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('bar').fields('my.field').toJSON());
                });

                test('correctly removes query on changing input string to empty string', function() {
                    expect(component.query).not.to.exist;
                    component.value = 'foo';
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('foo').fields('my.field').toJSON());
                    component.value = '';
                    component._build();
                    expect(component.query).not.to.exist;
                });

                test('correctly changes query on changing input string to null', function() {
                    expect(component.query).not.to.exist;
                    component.value = 'foo';
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('foo').fields('my.field').toJSON());
                    component.value = null;
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.MatchAllQuery().toJSON());
                });

                test('correctly creates query on changing empty input to string', function() {
                    expect(component.query).not.to.exist;
                    component.value = '';
                    component._build();
                    expect(component.query).not.to.exist;
                    component.value = 'foo';
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('foo').fields('my.field').toJSON());
                });

                test('correctly creates query on changing empty input to null', function() {
                    expect(component.query).not.to.exist;
                    component.value = '';
                    component._build();
                    expect(component.query).not.to.exist;
                    component.value = null;
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.MatchAllQuery().toJSON());
                });

                test('correctly changes query on changing null input to string', function() {
                    expect(component.query).not.to.exist;
                    component.value = null;
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.MatchAllQuery().toJSON());
                    component.value = 'foo';
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('foo').fields('my.field').toJSON());
                });

                test('correctly removes query on changing null input to empty', function() {
                    expect(component.query).not.to.exist;
                    component.value = null;
                    component._build();
                    expect(component.query).to.exist;
                    expect(component.query.toJSON()).to.deep.equal(ejs.MatchAllQuery().toJSON());
                    component.value = '';
                    component._build();
                    expect(component.query).not.to.exist;
                });

                test('non-advanced search does escape + in value', function() {
                    component.value = 'my+value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape - in value', function() {
                    component.value = 'my-value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape = in value', function() {
                    component.value = 'my=value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape & in value', function() {
                    component.value = 'my&value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape | in value', function() {
                    component.value = 'my|value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape > in value', function() {
                    component.value = 'my>value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape < in value', function() {
                    component.value = 'my<value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape ! in value', function() {
                    component.value = 'my!value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape ( and ) in value', function() {
                    component.value = '(my value)';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape { and } in value', function() {
                    component.value = '{my value}';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape [ and ] in value', function() {
                    component.value = '[my value]';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape ^ in value', function() {
                    component.value = 'my^value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape " in value', function() {
                    component.value = '"my value"';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape ~ in value', function() {
                    component.value = 'my~value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape * in value', function() {
                    component.value = 'my*value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape ? in value', function() {
                    component.value = 'my?value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape \\ in value', function() {
                    component.value = 'my\\value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape single / in value', function() {
                    component.value = 'my/value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('non-advanced search does escape double / in value', function() {
                    component.value = '/my value/';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my value').fields('my.field').toJSON());
                });

                test('advanced search does not escape + in value', function() {
                    component.advanced = true;
                    component.value = 'my+value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my+value').fields('my.field').toJSON());
                });

                test('advanced search does not escape - in value', function() {
                    component.advanced = true;
                    component.value = 'my-value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my-value').fields('my.field').toJSON());
                });

                test('advanced search does not escape = in value', function() {
                    component.advanced = true;
                    component.value = 'my=value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my=value').fields('my.field').toJSON());
                });

                test('advanced search does not escape & in value', function() {
                    component.advanced = true;
                    component.value = 'my&value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my&value').fields('my.field').toJSON());
                });

                test('advanced search does not escape | in value', function() {
                    component.advanced = true;
                    component.value = 'my|value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my|value').fields('my.field').toJSON());
                });

                test('advanced search does not escape > in value', function() {
                    component.advanced = true;
                    component.value = 'my>value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my>value').fields('my.field').toJSON());
                });

                test('advanced search does not escape < in value', function() {
                    component.advanced = true;
                    component.value = 'my<value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my<value').fields('my.field').toJSON());
                });

                test('advanced search does not escape ! in value', function() {
                    component.advanced = true;
                    component.value = 'my!value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my!value').fields('my.field').toJSON());
                });

                test('advanced search does not escape ( and ) in value', function() {
                    component.advanced = true;
                    component.value = '(my value)';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('(my value)').fields('my.field').toJSON());
                });

                test('advanced search does not escape { and } in value', function() {
                    component.advanced = true;
                    component.value = '{my value}';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('{my value}').fields('my.field').toJSON());
                });

                test('advanced search does not escape [ and ] in value', function() {
                    component.advanced = true;
                    component.value = '[my value]';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('[my value]').fields('my.field').toJSON());
                });

                test('advanced search does not escape ^ in value', function() {
                    component.advanced = true;
                    component.value = 'my^value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my^value').fields('my.field').toJSON());
                });

                test('advanced search does not escape " in value', function() {
                      component.advanced = true;
                    component.value = '"my value"';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('"my value"').fields('my.field').toJSON());
                });

                test('advanced search does not escape ~ in value', function() {
                    component.advanced = true;
                    component.value = 'my~value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my~value').fields('my.field').toJSON());
                });

                test('advanced search does not escape * in value', function() {
                    component.advanced = true;
                    component.value = 'my*value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my*value').fields('my.field').toJSON());
                });

                test('advanced search does not escape ? in value', function() {
                    component.advanced = true;
                    component.value = 'my?value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my?value').fields('my.field').toJSON());
                });

                test('advanced search does not escape \\ in value', function() {
                    component.advanced = true;
                    component.value = 'my\\value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my\\value').fields('my.field').toJSON());
                });

                test('advanced search does not escape single / in value', function() {
                    component.advanced = true;
                    component.value = 'my/value';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('my/value').fields('my.field').toJSON());
                });

                test('advanced search does not escape double / in value', function() {
                    component.advanced = true;
                    component.value = '/my value/';
                    component._build();
                    expect(component.query.toJSON()).to.deep.equal(ejs.QueryStringQuery('/my value/').fields('my.field').toJSON());
                });
            });
        </script>
    </body>
</html>
