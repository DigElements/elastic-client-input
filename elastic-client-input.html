<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="./elasticjs.html">

<!--
An element which renders an input box and produces an elasticjs query based on the input value.

Example:

        <elastic-client-input
            field="field.path"
            label-value="My Input"
            value="{{inputValue}}"
            query="{{resultingQuery}}">
        </elastic-client-input>

@demo demo/index.html
-->

<dom-module id="elastic-client-input">
    <style>
        .container {
            @apply(--layout-horizontal);
            @apply(--layout-end);
        }
        paper-icon-button {
            @apply(--paper-icon-button);
        }
    </style>
    <template>
        <div class="container">
            <paper-input class="flex"
                label="{{labelValue}}"
                value="{{_input}}"
                on-keydown="_onKeydown">
            </paper-input>
            <paper-icon-button icon="search" title="Search" on-tap="_buildQuery"></paper-icon-button>
        </div>

    </template>

    <script>
        Polymer({
            is: 'elastic-client-input',

            properties: {
                // The field which the resulting elasticjs query should
                // be targetted against
                field: {
                    type: String
                },

                // The raw input string
                value: {
                    type: String,
                    notify: true,
                    observer: '_buildQueryUsingValue'
                },

                // The resulting elasticjs query from this input
                query: {
                    type: Object,
                    readOnly: true,
                    notify: true
                },

                // Whether advanced search mode is enabled.
                advanced: {
                    type: Boolean,
                    value: false
                },

                // Specifies the label for the input field. If not specified
                // the field will be used
                label: {
                    type: String,
                    value: ''
                },

                // The computed label; derived from the label or the field
                labelValue: {
                    type: String,
                    readOnly: true,
                    computed: '_computeLabelValue(field, label)'
                },

                _input: {
                    type: String
                }
            },

            /**
             * Builds the elasticjs query based on the input field value
            */
            _buildQuery: function() {
                this.value = this._input;
                if(this._input === null) {
                    this._setQuery(ejs.MatchAllQuery());
                }
                else {
                    var queryValue = (this.advanced ? (this._input || '') : this._removeReservedCharacters(this._input || '')).trim();
                    if(queryValue) {
                        this._setQuery(ejs.QueryStringQuery(queryValue).fields(this.field));
                    }
                    else {
                        this._setQuery(undefined);
                    }
                }
            },

            _buildQueryUsingValue: function() {
                this._input = this.value;
                this._buildQuery();
            },

            _computeLabelValue: function(field, label) {
                return label || field;
            },

            _onKeydown: function(event) {
              if(event.keyCode === 13 && this.field) {
                this._buildQuery();
              }
            },

            _removeReservedCharacters: function(value) {
                return value.replace(/\+|\-|\=|\&|\||\>|\<|\!|\(|\)|\{|\}|\[|\]|\^|\"|\~|\*|\?|\:|\\|\//g, ' ');
            }
        });
    </script>
</dom-module>
